<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szlachetna Dziczyzna - Zam√≥wienia Online</title>
    
    <!-- Ikonka dzika w przeglƒÖdarce -->
    <link rel="icon" href="https://fav.farm/üêó" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          // Twoje ustawione ID - nie zmieniaj
          emailjs.init("zX_JndIVFBCrktjp8"); 
       })();
    </script>

    <!-- Ustawienia dla Facebooka / Messengera -->
    <meta property="og:title" content="Szlachetna Dziczyzna" />
    <meta property="og:description" content="≈öwie≈ºe wyroby prosto z lasu. Sprawd≈∫ ofertƒô i zam√≥w z dostawƒÖ osobistƒÖ." />
    <!-- Je≈õli masz link do zdjƒôcia, wklej go w content="" poni≈ºej -->
    <meta property="og:image" content="logo.png" />
    <meta property="og:type" content="website" />

    <style>
        body { background-color: #fdfbf7; color: #2c3e50; }
        .accent-bg { background-color: #3f4f3a; }
        .accent-text { color: #3f4f3a; }
        .out-of-stock { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="font-sans antialiased pb-20">

    <header class="accent-bg text-white py-12 text-center shadow-md">
        <div class="flex flex-col items-center gap-6">
            <img src="logo.png" alt="Szlachetna Dziczyzna" class="w-[400px] max-w-[90vw] h-auto drop-shadow-lg">
            <div class="sr-only">
                <h1>Szlachetna Dziczyzna</h1>
                <p>Manufaktura wyrob√≥w rzemie≈õlniczych z polskich las√≥w</p>
            </div>
        </div>
    </header>

    <div class="max-w-5xl mx-auto p-6 bg-white shadow-lg mt-[-30px] rounded-lg relative z-10">
        
        <form id="order-form" onsubmit="sendOrder(event)">
            <div class="grid md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <section class="mb-6 p-4 md:p-5 bg-amber-50 border border-amber-200 rounded-lg shadow-sm">
                        <h2 class="text-xl font-serif accent-text mb-2">Dlaczego nasza dziczyzna?</h2>
                        <p class="text-sm text-amber-900 leading-relaxed">
                            Je≈õli chcesz mieƒá pewno≈õƒá, ≈ºe w miƒôsie jest 100% miƒôsa ‚Äì bez antybiotyk√≥w, bez szczepionek, bez wype≈Çniaczy i bez sztucznej paszy ‚Äì dobrze trafi≈Çe≈õ. Nasza dziczyzna pochodzi z wolnych zwierzƒÖt ≈ºyjƒÖcych w naturalnych warunkach. Starannie wyselekcjonowana i przygotowana wed≈Çug tradycyjnych receptur, z pasjƒÖ i szacunkiem do natury.
                        </p>
                        <p class="text-sm text-amber-900 leading-relaxed mt-3">
                            Ka≈ºda partia miƒôsa jest przebadana przez uprawnionego lekarza weterynarii i dopuszczona do spo≈ºycia. Nasze wyroby spe≈ÇniajƒÖ wszystkie obowiƒÖzujƒÖce normy sanitarne, dziƒôki czemu masz pewno≈õƒá, ≈ºe kupujesz dziczyznƒô bezpiecznƒÖ i najwy≈ºszej jako≈õci.
                        </p>
                    </section>

                    <h2 class="text-2xl font-serif mb-2 border-b pb-2 accent-text">Wybierz produkty</h2>
                    <p class="text-sm text-amber-800 mb-6">Minimalna warto≈õƒá zam√≥wienia: <strong>200 z≈Ç</strong>.</p>
                    
                    <div class="space-y-6" id="products-container">
                        <p class="text-center text-gray-500 py-10">≈Åadowanie oferty z arkusza...</p>
                    </div>

                    <!-- Kody rabatowe -->
                    <div class="mb-4">
                        <div class="bg-amber-50 border-l-4 border-amber-600 p-4 text-sm text-amber-900">
                            <p class="font-bold">‚öñÔ∏è Informacja o wadze:</p>
                            <p>Waga produkt√≥w jest orientacyjna (+/- 10%). Dok≈ÇadnƒÖ kwotƒô podamy po zwa≈ºeniu produkt√≥w.</p>
                        </div>
                    </div>

                    <div class="mt-8 flex items-center justify-end gap-2">
                        <input type="text" id="discount-code" placeholder="Kod rabatowy" class="p-2 border rounded text-sm w-40 uppercase">
                        <button type="button" onclick="applyDiscount()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold">U≈ºyj</button>
                    </div>
                    <p id="discount-message" class="text-right text-xs mt-1 text-green-600 font-bold h-4"></p>

                    <h2 class="text-2xl font-serif mt-10 mb-6 border-b pb-2 accent-text">Dane do dostawy</h2>
                    
                    <div class="bg-green-50 border-l-4 border-green-700 p-4 mb-6 text-sm text-green-900">
                        <p class="font-bold">üöö Dostawa:</p>
                        <p>Dostawy realizujemy <strong>wy≈ÇƒÖcznie osobi≈õcie w poniedzia≈Çki</strong>. Zam√≥wienia przyjmowane sƒÖ od poniedzia≈Çku do czwartku.</p>
                        <p>Dostarczamy do 30 km od Warszawy.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" name="imie_nazwisko" placeholder="Imiƒô i Nazwisko" required class="p-3 border rounded w-full">
                        <input type="tel" name="telefon" placeholder="Numer telefonu" required class="p-3 border rounded w-full">
                        <input type="email" name="email" placeholder="Adres Email" required class="p-3 border rounded w-full md:col-span-2">
                        <input type="text" name="miasto" placeholder="Miejscowo≈õƒá" required class="p-3 border rounded w-full">
                        <input type="text" name="ulica" placeholder="Ulica i numer domu" required class="p-3 border rounded w-full">
                        <textarea name="uwagi" placeholder="Uwagi (np. kod do domofonu)" class="p-3 border rounded w-full md:col-span-2" rows="2"></textarea>
                    </div>
                    <div id="form-errors" class="text-sm text-red-600 mt-2 hidden"></div>

                    <div class="mt-6 text-sm text-gray-600">
                        <label class="flex items-start gap-2">
                            <input type="checkbox" required class="mt-1">
                            <span>Wyra≈ºam zgodƒô na realizacjƒô zam√≥wienia i akceptujƒô termin dostawy (Czwartek).</span>
                        </label>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full accent-bg text-white font-bold py-4 rounded mt-8 hover:opacity-90 transition text-lg shadow-lg">
                        Z≈Ç√≥≈º zam√≥wienie
                    </button>
                    <p id="status-msg" class="text-center mt-4 hidden"></p>
                </div>

                <!-- PODSUMOWANIE KOSZYKA -->
                <div class="bg-gray-100 p-6 rounded-lg shadow-inner md:sticky md:top-6 h-fit">
                    <h3 class="font-bold text-gray-700 border-b pb-2 mb-2">Tw√≥j koszyk:</h3>
                    
                    <div id="cart-summary-list" class="text-sm space-y-2 mb-4 text-gray-600">
                        <p class="italic text-gray-400">Brak produkt√≥w.</p>
                    </div>

                    <div class="text-right border-t pt-4">
                        <span class="text-xl">Do zap≈Çaty (orientacyjnie): <strong id="total-price" class="accent-text text-2xl">0.00 z≈Ç</strong></span>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <footer class="text-center text-gray-500 text-sm pb-10">
        <p>&copy; 2024 Szlachetna Dziczyzna.</p>
        <p class="mt-2">W razie pyta≈Ñ proszƒô o kontakt telefoniczny: <strong>+48 791 177 777</strong>.</p>
    </footer>

    <script>
        // === KONFIGURACJA ===
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSFPe99P7zAoHCVOezMhJPVMIwXJyaIl4MkHj8phq7Tq3ECF-e_5JXGYy2y3XP2GDO290G3djadkkPr/pub?output=csv'; 
        const SHEET_ID = '18bHIaug8Jv424muP0_r9mrmMglJbNqHGhnHTLELrzLE';
        const SHEET_TAB = 'Zamowienia';
        
        // Tw√≥j link do Google Apps Script (zapisywanie zam√≥wie≈Ñ)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVPB_OU3RqhmYXkTaaRIjqLTdB-WxlbJcl0BCd23ynqjj1QS1ZmMRexWOrr9E8e0Av/exec";
        
        // Twoje dane EmailJS (ju≈º wpisane)
        const EMAILJS_SERVICE = "service_5g54m0r";
        const EMAILJS_TEMPLATE = "template_5gttgro";
        
        const DISCOUNT_CODES = { "LAS2024": 0.05, "START": 0.10, "ZNAJOMY": 0.10 };
        const CATEGORY_ORDER = ["Kie≈Çbasy", "Wƒôdliny", "Przetwory", "Inne"];
        const MIN_ORDER = 200; // minimalna warto≈õƒá zam√≥wienia w z≈Ç
        const REQUEST_TIMEOUT_MS = 12000;
        let currentDiscount = 0;
        let hasItemsInCart = false;

        function parsePrice(priceString) {
            if (!priceString) return 0;
            let cleanString = priceString.toString().replace(/z≈Ç/g, '').replace(/,/g, '.').trim();
            return parseFloat(cleanString) || 0;
        }

        function sanitizeQtyInput(input) {
            const step = parseFloat(input.step) || 0.1;
            const decimals = (step.toString().split('.')[1] || '').length;
            const maxStock = isFinite(parseFloat(input.dataset.stock)) ? parseFloat(input.dataset.stock) : null;
            let val = parseFloat(input.value) || 0;
            val = Math.max(0, val);
            if (maxStock !== null) val = Math.min(val, maxStock);
            const rounded = decimals === 0 ? Math.round(val) : Math.round(val / step) * step;
            const fixed = decimals === 0 ? rounded : parseFloat(rounded.toFixed(decimals));
            let finalVal = decimals === 0 ? fixed : parseFloat(fixed.toFixed(decimals));
            if (maxStock !== null && finalVal > maxStock) finalVal = maxStock;
            input.value = decimals === 0 ? String(finalVal) : finalVal.toFixed(decimals);
            return parseFloat(input.value) || 0;
        }

        function generateOrderNumber() {
            try {
                const key = 'orderCounter';
                let current = parseInt(localStorage.getItem(key), 10);
                if (isNaN(current) || current < 300) current = 300;
                const next = current + 1;
                localStorage.setItem(key, next);
                return `DZ-${next}`;
            } catch (e) {
                return `DZ-${Date.now()}`;
            }
        }

        async function requestOrderNumber() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
            const payload = {
                action: "nextOrderNumber",
                sheet_id: SHEET_ID,
                sheet_tab: SHEET_TAB
            };
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                if (!response.ok) throw new Error("order-number-http");
                const data = await response.json().catch(() => null);
                const nr = data && (data.orderNumber || data.order_number || data.number);
                if (!nr) throw new Error("order-number-missing");
                return nr;
            } catch (err) {
                console.warn("Nie uda≈Ço siƒô pobraƒá numeru z serwera, u≈ºywam lokalnego.", err);
                return generateOrderNumber();
            } finally {
                clearTimeout(timeoutId);
            }
        }

        function setStatus(message, isError = false, isPending = false) {
            const status = document.getElementById('status-msg');
            status.classList.remove('hidden');
            status.className = `text-center mt-4 font-bold p-4 rounded ${isError ? 'text-red-700 bg-red-50' : 'text-green-700 bg-green-50'} ${isPending ? 'animate-pulse' : ''}`;
            status.innerHTML = message;
        }

        function clearStatus() {
            const status = document.getElementById('status-msg');
            status.classList.add('hidden');
            status.textContent = '';
            status.className = 'text-center mt-4 hidden';
        }

        function setFormError(text) {
            const box = document.getElementById('form-errors');
            if (!text) {
                box.classList.add('hidden');
                box.textContent = '';
                return;
            }
            box.classList.remove('hidden');
            box.textContent = text;
        }

        function validateFormFields() {
            const form = document.forms['order-form'];
            const requiredFields = [
                { field: form.imie_nazwisko, label: "Imiƒô i nazwisko" },
                { field: form.telefon, label: "Telefon" },
                { field: form.email, label: "Email" },
                { field: form.miasto, label: "Miejscowo≈õƒá" },
                { field: form.ulica, label: "Ulica i numer" },
            ];

            for (const { field, label } of requiredFields) {
                if (!field.value.trim()) {
                    setFormError(`Uzupe≈Çnij pole: ${label}.`);
                    field.focus();
                    return false;
                }
            }

            const phoneValid = /^[0-9 +()-]{6,}$/.test(form.telefon.value.trim());
            if (!phoneValid) {
                setFormError("Podaj poprawny numer telefonu.");
                form.telefon.focus();
                return false;
            }

            setFormError('');
            return true;
        }

        Papa.parse(SHEET_URL, {
            download: true,
            header: true,
            complete: function(results) {
                if(results.data.length === 0) {
                     document.getElementById('products-container').innerHTML = '<p class="text-red-500 text-center font-bold">Arkusz jest pusty lub b≈ÇƒÖd odczytu.</p>';
                     return;
                }
                renderProducts(results.data);
            },
            error: function(err) {
                console.error("B≈ÇƒÖd PapaParse:", err);
                document.getElementById('products-container').innerHTML = '<div class="text-center text-red-600 font-bold">B≈ÇƒÖd ≈Çadowania oferty.</div>';
            }
        });

        function normalizeCategory(catRaw, name = '', desc = '') {
            const c = (catRaw || '').toString().toLowerCase();
            const n = (name || '').toString().toLowerCase();
            const d = (desc || '').toString().toLowerCase();

            const matchKielbasy = (text) => text.includes('kie≈Çb') || text.includes('kielb') || text.includes('kabanos') || text.includes('par√≥w') || text.includes('grill');
            const matchWedliny = (text) => text.includes('wƒôdlin') || text.includes('wedlin') || text.includes('szynk') || text.includes('boczek') || text.includes('polƒôd') || text.includes('poled') || text.includes('baleron') || text.includes('schab');
            const matchPrzetwory = (text) => text.includes('przetw') || text.includes('paszt') || text.includes('smalec') || text.includes('gulasz') || text.includes('konserw') || text.includes('bulion') || text.includes('s≈Çoik') || text.includes('sloik');

            if (matchKielbasy(c) || matchKielbasy(n) || matchKielbasy(d)) return "Kie≈Çbasy";
            if (matchWedliny(c) || matchWedliny(n) || matchWedliny(d)) return "Wƒôdliny";
            if (matchPrzetwory(c) || matchPrzetwory(n) || matchPrzetwory(d)) return "Przetwory";
            return c ? c.charAt(0).toUpperCase() + c.slice(1) : "Inne";
        }

        function slugifyCategory(name) {
            return name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        }

        function renderProducts(data) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';

            const categories = {};
            let idx = 0;

            data.forEach((item) => {
                if (!item['Nazwa']) return; 
                const category = normalizeCategory(item['Kategoria'] || item['Kategoria (PL)'] || item['Kategoria1'], item['Nazwa'], item['Opis']);

                const stock = parseFloat(item['Dostƒôpno≈õƒá']);
                const maxQty = isFinite(stock) && stock > 0 ? stock : null;
                const isAvailable = maxQty ? maxQty > 0 : stock > 0;
                const disabledClass = isAvailable ? '' : 'out-of-stock';
                const statusText = '';
                const soldOutNote = isAvailable ? '' : '<span class="text-xs font-bold text-red-700 mt-2 block">Wyprzedane</span>';
                
                const unit = item['Jednostka'] || 'kg';
                const step = unit.toLowerCase().includes('szt') ? 1 : 0.1;
                const expiry = item['Wa≈ºno≈õƒá'];
                const sklad = item['Sk≈Çad'] || '';
                const cena = parsePrice(item['Cena']);
                const opis = item['Opis'] || '';
                const nazwa = item['Nazwa'];
                let imageUrl = item['Zdjƒôcie'] || item['Zdjecie'] || item['Foto'] || item['Obraz'] || '';
                const nameSlug = (nazwa || '').toString().toLowerCase();
                if (!imageUrl && nameSlug.includes('kielbasa') && nameSlug.includes('dzik')) {
                    imageUrl = 'kielbasadzik.jpg';
                }
                const imageBlock = imageUrl ? `
                    <img src="${imageUrl}" alt="Zdjƒôcie produktu ${nazwa}" class="w-full h-32 object-cover rounded-lg border shadow-sm">
                ` : `
                    <div class="w-full h-32 bg-gray-100 text-gray-400 text-xs rounded-lg border flex items-center justify-center">
                        Brak zdjƒôcia
                    </div>
                `;

                const productIndex = idx;
                idx += 1;
                const hasDetails = Boolean(opis || sklad || expiry);
                const detailsId = `details-${productIndex}`;
                const detailsButton = hasDetails ? `
                    <button type="button" class="text-sm font-semibold text-amber-800 flex items-center gap-2 mt-2" onclick="toggleDetails('${detailsId}', this)">
                        <span class="inline-block transition-transform rotate-0">‚ñº</span>
                        <span>Szczeg√≥≈Çy</span>
                    </button>
                ` : '';
                const detailsBlock = hasDetails ? `
                    <div id="${detailsId}" class="mt-2 text-sm text-gray-700 bg-amber-50 border border-amber-100 rounded-lg p-3 hidden">
                        ${opis ? `<p class="leading-snug">${opis}</p>` : ''}
                        ${sklad ? `<p class="text-xs italic text-gray-500 mt-2"><span class="font-semibold not-italic text-gray-700">Sk≈Çad:</span> ${sklad}</p>` : ''}
                        ${expiry ? `<p class="text-xs text-amber-700 font-semibold mt-2">‚è≥ Wa≈ºno≈õƒá: ${expiry}</p>` : ''}
                    </div>
                ` : '';

                const html = `
                <div class="flex flex-col sm:flex-row justify-between sm:items-start border-b pb-6 product-item ${disabledClass}" data-index="${productIndex}">
                    <div class="flex flex-col sm:flex-row gap-4 w-full pr-4">
                        <div class="flex-1 mb-4 sm:mb-0 order-1 sm:order-2">
                            <h3 class="font-bold text-lg text-gray-800 flex items-center">
                                <span class="text-gray-400 mr-2">${idx}.</span> ${nazwa} ${statusText}
                            </h3>
                            <div class="mt-2 sm:hidden">
                                ${imageBlock}
                            </div>
                            ${detailsButton}
                            ${detailsBlock}
                            <div class="mt-3 inline-flex items-center gap-2 px-3 py-2 bg-amber-100 text-amber-900 rounded-lg shadow-sm">
                                <span class="text-sm font-semibold">Cena jedn.:</span>
                                <span class="price text-lg font-extrabold tracking-tight" data-price="${cena}">
                                    ${cena.toFixed(2)} z≈Ç
                                </span>
                                <span class="text-xs font-semibold text-amber-800">/ ${unit}</span>
                            </div>
                        </div>
                        <div class="w-full sm:w-32 flex-shrink-0 order-2 sm:order-1 hidden sm:block">
                            ${imageBlock}
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-end sm:items-center mt-2 sm:mt-0">
                        <div class="flex items-center bg-gray-50 p-2 rounded-lg">
                            <button type="button" onclick="changeQty(${productIndex}, -${step})" class="w-10 h-10 flex items-center justify-center bg-white border rounded hover:bg-gray-100 text-xl font-bold text-gray-600 shadow-sm">-</button>
                            
                            <input type="number" 
                                min="0" 
                                step="${step}" 
                                placeholder="0" 
                                id="qty-${productIndex}"
                                class="qty-input w-20 p-2 mx-2 text-center bg-transparent border-b outline-none font-bold text-lg" 
                                name="${nazwa}"
                                data-unit="${unit}"
                                data-stock="${maxQty !== null ? maxQty : ''}"
                                oninput="calculateTotal()">
                            
                            <button type="button" onclick="changeQty(${productIndex}, ${step})" class="w-10 h-10 flex items-center justify-center bg-white border rounded hover:bg-gray-100 text-xl font-bold text-gray-600 shadow-sm">+</button>
                        </div>
                        <p id="line-total-${productIndex}" class="text-sm font-bold text-green-700 mt-2 opacity-0 transition-opacity duration-200">0.00 z≈Ç</p>
                        ${soldOutNote}
                        ${maxQty ? `<span class="text-xs text-amber-700 font-semibold mt-1 block">Zosta≈Ço ostatnie ${maxQty} ${unit}.</span>` : ''}
                    </div>
                </div>`;
                
                if (!categories[category]) categories[category] = [];
                categories[category].push({ name: nazwa, html });
            });

            CATEGORY_ORDER.forEach((catName) => {
                if (!categories[catName] || categories[catName].length === 0) return;
                const sortedItems = categories[catName].sort((a, b) => {
                    if (catName === "Kie≈Çbasy") {
                        const pri = (name) => {
                            const t = name.toLowerCase();
                            if (t.includes('par√≥w')) return 0;
                            if (t.includes('kielb') || t.includes('kie≈Çb')) return 1;
                            if (t.includes('kabanos')) return 2;
                            return 3;
                        };
                        const pa = pri(a.name);
                        const pb = pri(b.name);
                        if (pa !== pb) return pa - pb;
                    }
                    if (catName === "Wƒôdliny") {
                        const pri = (name) => {
                            const t = name.toLowerCase();
                            if (t.includes('szynk')) return 0;
                            if (t.includes('salami')) return 1;
                            if (t.includes('polƒôd') || t.includes('poled')) return 2;
                            return 3;
                        };
                        const pa = pri(a.name);
                        const pb = pri(b.name);
                        if (pa !== pb) return pa - pb;
                    }
                    return a.name.localeCompare(b.name, 'pl');
                });
                let localIdx = 1;
                const rendered = sortedItems.map(item => {
                    const numbered = item.html.replace(/<span class="text-gray-400 mr-2">.*?<\/span>/, `<span class="text-gray-400 mr-2">${localIdx}.<\/span>`);
                    localIdx += 1;
                    return numbered;
                });
                const sectionId = `cat-${slugifyCategory(catName)}`;
                const sectionHtml = `
                <div class="category-section border rounded-lg mb-4 overflow-hidden">
                    <button type="button" class="w-full flex justify-between items-center bg-gray-50 px-4 py-3 font-bold accent-text text-left" onclick="toggleCategory('${sectionId}')">
                        <span>${catName}</span>
                        <span id="${sectionId}-chevron" class="transition-transform rotate-180">‚ñº</span>
                    </button>
                    <div id="${sectionId}" class="category-body divide-y hidden">
                        ${rendered.join('')}
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', sectionHtml);
            });
        }

        window.changeQty = function(index, delta) {
            const input = document.getElementById(`qty-${index}`);
            let val = parseFloat(input.value) || 0;
            val += delta;
            input.value = val;
            sanitizeQtyInput(input);
            calculateTotal();
        }

        window.toggleCategory = function(id) {
            const body = document.getElementById(id);
            const chevron = document.getElementById(`${id}-chevron`);
            if (!body) return;
            body.classList.toggle('hidden');
            if (chevron) chevron.classList.toggle('rotate-180');
        }

        window.toggleDetails = function(id, btn) {
            const body = document.getElementById(id);
            if (!body) return;
            const willShow = body.classList.contains('hidden');
            body.classList.toggle('hidden');
            if (btn) {
                const spans = btn.querySelectorAll('span');
                if (spans[0]) spans[0].classList.toggle('rotate-180', willShow);
                if (spans[1]) spans[1].textContent = willShow ? 'Ukryj szczeg√≥≈Çy' : 'Szczeg√≥≈Çy';
            }
        }

        window.adjustCartItem = function(index, delta) {
            const input = document.getElementById(`qty-${index}`);
            if (!input) return;
            let val = parseFloat(input.value) || 0;
            val += delta;
            input.value = val;
            sanitizeQtyInput(input);
            calculateTotal();
        }

        window.removeCartItem = function(index) {
            const input = document.getElementById(`qty-${index}`);
            if (!input) return;
            input.value = 0;
            calculateTotal();
        }

        window.calculateTotal = function() {
            let total = 0;
            const cartSummary = document.getElementById('cart-summary-list');
            let summaryHTML = '';
            let hasItems = false;

            hasItemsInCart = false;

            document.querySelectorAll('.product-item').forEach((item) => {
                if (item.classList.contains('out-of-stock')) return;
                
                const index = item.dataset.index;
                const name = item.querySelector('h3').textContent.trim().replace('(Wyprzedane)', '');
                const price = parseFloat(item.querySelector('.price').dataset.price);
                const input = item.querySelector('.qty-input');
                const unit = input.dataset.unit;
                const stepVal = parseFloat(input.step) || 0.1;
                const qty = sanitizeQtyInput(input);
                
                const lineTotal = price * qty;
                const lineTotalEl = document.getElementById(`line-total-${index}`);
                
                if(lineTotalEl) {
                    if (qty > 0) {
                        lineTotalEl.textContent = lineTotal.toFixed(2) + ' z≈Ç';
                        lineTotalEl.classList.remove('opacity-0');
                        hasItems = true;
                        hasItemsInCart = true;
                        summaryHTML += `
                        <div class="flex justify-between items-center border-b border-gray-200 border-dashed pb-1 last:border-0">
                            <div class="space-y-1">
                                <span class="font-semibold text-gray-800">${name}</span>
                                <div class="flex flex-wrap items-center gap-2 text-xs text-gray-600">
                                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-amber-50 border border-amber-200 rounded-full text-amber-800 font-semibold">
                                        <span class="text-sm">${qty}</span>
                                        <span class="text-[10px] uppercase tracking-wide">${unit}</span>
                                    </span>
                                    <div class="inline-flex items-center gap-1">
                                        <button type="button" class="px-2 py-1 border rounded-lg bg-white hover:bg-gray-100" onclick="adjustCartItem(${index}, -${stepVal})">-</button>
                                        <button type="button" class="px-2 py-1 border rounded-lg bg-white hover:bg-gray-100" onclick="adjustCartItem(${index}, ${stepVal})">+</button>
                                        <button type="button" class="px-2 py-1 border rounded-lg bg-white hover:bg-red-50 text-red-600 border-red-200" onclick="removeCartItem(${index})">Usu≈Ñ</button>
                                    </div>
                                </div>
                            </div>
                            <span class="font-semibold">${lineTotal.toFixed(2)} z≈Ç</span>
                        </div>`;
                    } else {
                        lineTotalEl.classList.add('opacity-0');
                    }
                }
                total += lineTotal;
            });

            let discountAmount = 0;
            if (currentDiscount > 0 && total > 0) {
                discountAmount = total * currentDiscount;
                summaryHTML += `
                <div class="flex justify-between items-center text-green-700 mt-2 pt-2 border-t">
                    <span>Rabat (${currentDiscount * 100}%)</span>
                    <span class="font-bold">-${discountAmount.toFixed(2)} z≈Ç</span>
                </div>`;
                total = total - discountAmount;
            }

            if (hasItems) {
                cartSummary.innerHTML = summaryHTML;
            } else {
                cartSummary.innerHTML = '<p class="italic text-gray-400">Wybierz produkty powy≈ºej, aby zobaczyƒá podsumowanie.</p>';
            }

            document.getElementById('total-price').textContent = total.toFixed(2) + ' z≈Ç';
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = !hasItemsInCart;
            submitBtn.classList.toggle('opacity-50', !hasItemsInCart);
        }

        window.applyDiscount = function() {
            const codeInput = document.getElementById('discount-code').value.toUpperCase();
            const msg = document.getElementById('discount-message');
            if (DISCOUNT_CODES[codeInput]) {
                currentDiscount = DISCOUNT_CODES[codeInput];
                msg.textContent = `Kod aktywny! -${currentDiscount * 100}%`;
                msg.className = "text-right text-xs mt-1 text-green-600 font-bold h-4";
            } else {
                currentDiscount = 0;
                msg.textContent = "B≈Çƒôdny kod.";
                msg.className = "text-right text-xs mt-1 text-red-500 font-bold h-4";
            }
            calculateTotal();
        }

        function saveOrderToSheet(orderData) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);

            const send = (mode) => fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData),
                signal: controller.signal
            });

            return send("cors")
                .then((response) => {
                    if (response.type === 'opaque') return;
                    if (!response.ok) throw new Error("sheet-save-failed");
                    return response.json().catch(() => ({}));
                })
                .catch((err) => {
                    if (err.name === 'AbortError') {
                        throw new Error("sheet-save-timeout");
                    }
                    // Je≈õli CORS siƒô wywali, pr√≥bujemy best-effort no-cors
                    return send("no-cors").catch(() => { throw err; });
                })
                .finally(() => clearTimeout(timeoutId));
        }

        window.sendOrder = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const status = document.getElementById('status-msg');
            const totalText = document.getElementById('total-price').innerText || '0';
            const totalValue = parseFloat(
                totalText
                    .replace('z≈Ç', '')
                    .replace(/\s/g, '')
                    .replace(',', '.')
            );
            if (isNaN(totalValue) || totalValue < MIN_ORDER) {
                alert(`Minimalna warto≈õƒá zam√≥wienia to ${MIN_ORDER} z≈Ç.`);
                return;
            }

            clearStatus();
            if (!validateFormFields()) return;

            setStatus("Pobieram numer zam√≥wienia...", false, true);
            const orderNumber = await requestOrderNumber();
            let orderSummary = `Numer zam√≥wienia: ${orderNumber}\n`;
            let hasProducts = false;
            let lineItems = [];

            document.querySelectorAll('.product-item').forEach((item) => {
                const index = item.dataset.index;
                const input = item.querySelector('.qty-input');
                const qty = parseFloat(input.value) || 0;
                
                if(qty > 0) {
                    hasProducts = true;
                    const name = item.querySelector('h3').textContent.trim().replace('(Wyprzedane)', '');
                    const unit = input.dataset.unit;
                    const linePrice = document.getElementById(`line-total-${index}`).textContent;
                    orderSummary += `${name}: ${qty} ${unit} (Razem: ${linePrice})\n`;
                    lineItems.push({ name, qty, unit });
                }
            });

            if(!hasProducts) { alert("Wybierz produkty."); return; }

            btn.disabled = true;
            btn.textContent = "Zapisywanie zam√≥wienia...";
            setStatus("Zapisywanie w systemie...", false, true);

            const form = document.forms['order-form'];
            const addressFull = `${form.ulica.value}, ${form.miasto.value}`;
            const totalPrice = document.getElementById('total-price').innerText;

            const orderData = {
                sheet_id: SHEET_ID,
                sheet_tab: SHEET_TAB,
                // Pola dla Arkusza Google
                imie_nazwisko: form.imie_nazwisko.value,
                email: form.email.value,
                telefon: form.telefon.value,
                adres: addressFull,
                uwagi: form.uwagi.value,
                szczegoly: orderSummary,
                zamowienie: orderSummary,
                kwota: totalPrice,
                line_items: lineItems,
                
                // Pola dla EmailJS
                to_name: "Sprzedawca",
                customer_name: form.imie_nazwisko.value,
                customer_email: form.email.value,
                phone: form.telefon.value,
                delivery_method: "Dostawa Osobista (Czwartek)", 
                address: addressFull,
                notes: form.uwagi.value,
                order_details: orderSummary,
                total_price: totalPrice,
                discount_info: currentDiscount > 0 ? "TAK" : "NIE",
                order_number: orderNumber
            };

            // KROK 1: WYSY≈ÅKA DO GOOGLE SHEETS
            saveOrderToSheet(orderData)
                .then(() => {
                    setStatus("Zapisywanie w systemie... OK. Wysy≈Çamy potwierdzenie e-mail.", false, true);
                    // KROK 2: WYSY≈ÅKA MAILA (EmailJS)
                return emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, orderData);
            })
            .then(() => {
                setStatus(`‚úÖ Zam√≥wienie przyjƒôte! Nr: ${orderNumber}. Zapisano w systemie i wys≈Çano potwierdzenie.`, false, false);
                btn.style.display = 'none';
            })
                .catch((err) => {
                    console.error("B≈ÇƒÖd:", err);
                    const errorMsg = err.message === "sheet-save-timeout"
                        ? "Nie uda≈Ço siƒô potwierdziƒá zapisu (przekroczono czas). Spr√≥buj ponownie lub skontaktuj siƒô telefonicznie."
                        : "Nie uda≈Ço siƒô zapisaƒá zam√≥wienia. Spr√≥buj ponownie lub skontaktuj siƒô telefonicznie.";
                    setStatus(`‚ö†Ô∏è ${errorMsg}`, true, false);
                    btn.disabled = false;
                    btn.textContent = "Spr√≥buj ponownie";
                });
        }
    </script>
</body>
</html>
