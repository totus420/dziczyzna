<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Szlachetna Dziczyzna - Zam√≥wienia Online</title>
    
    <!-- Ikonka dzika w przeglƒÖdarce -->
    <link rel="icon" href="https://fav.farm/üêó" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
       (function(){
          // Twoje ustawione ID - nie zmieniaj
          emailjs.init("zX_JndIVFBCrktjp8"); 
       })();
    </script>

    <!-- Ustawienia dla Facebooka / Messengera -->
    <meta property="og:title" content="Szlachetna Dziczyzna" />
    <meta property="og:description" content="≈öwie≈ºe wyroby prosto z lasu. Sprawd≈∫ ofertƒô i zam√≥w z dostawƒÖ osobistƒÖ." />
    <!-- Je≈õli masz link do zdjƒôcia, wklej go w content="" poni≈ºej -->
    <meta property="og:image" content="logo.png" />
    <meta property="og:type" content="website" />

    <!-- Czcionki: Inter (tekst) + Playfair Display (nag≈Ç√≥wki) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* T≈Ço strony + podstawowa typografia */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: #2c3e50;
            background: radial-gradient(circle at top, #4b5c45 0, #fdfbf7 55%, #f5efe3 100%);
        }

        /* Serif do nag≈Ç√≥wk√≥w ‚Äì nadpisujemy tailwindowe .font-serif */
        .font-serif {
            font-family: 'Playfair Display', ui-serif, Georgia, 'Times New Roman', serif;
        }

        :root {
            --forest-700: #3f4f3a;
            --amber-cream-50: #f7f2e8;
            --amber-cream-100: #eadbc4;
            --sage-50: #eef3ec;
            --sage-100: #d7e4d2;
            --sage-200: #c8d7c3;
            --sand-50: #f4f1ed;
            --sand-100: #e7dfd3;
            --sand-200: #d7c8b4;
        }

        .accent-bg { background-color: var(--forest-700); }
        .accent-text { color: var(--forest-700); }

        .section-intro {
            background-color: var(--amber-cream-50);
            border: 1px solid var(--amber-cream-100);
        }

        .section-products {
            background-color: var(--sage-50);
            border: 1px solid var(--sage-100);
        }

        .note-products {
            background-color: #e5efe0;
            border: 1px solid var(--sage-200);
            color: #2f3b2b;
        }

        .section-form {
            background-color: var(--sand-50);
            border: 1px solid var(--sand-100);
        }

        .note-form {
            background-color: #ebe2d6;
            border-left: 4px solid var(--sand-200);
            color: #4a4134;
        }

        .cart-panel {
            background-color: #efebe4;
            border: 1px solid var(--sand-100);
        }

        .out-of-stock {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="font-sans antialiased pb-20">

    <div class="sticky top-0 inset-x-0 z-40 bg-amber-900 text-amber-50 text-sm md:text-base py-2 px-4 text-center font-semibold shadow w-full">
        Nastƒôpna dostawa <strong>21.12</strong>. Zam√≥wienia do <strong>19.12</strong>.
    </div>

    <div id="promo-popup" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden">
        <div class="absolute inset-0 flex items-center justify-center px-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 border border-amber-200 relative">
                <button type="button" aria-label="Zamknij" onclick="closePromoPopup()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">‚úï</button>
                <h3 class="text-lg font-serif accent-text mb-3 text-center">Wa≈ºna informacja</h3>
                <p class="text-base text-gray-800 leading-relaxed text-center">
                    Nastƒôpna, przed≈õwiƒÖteczna dostawa <strong>21.12</strong> &mdash; zam√≥wienia prosimy sk≈Çadaƒá do <strong>19.12</strong>!
                </p>
                <div class="mt-5 text-center">
                    <button type="button" onclick="closePromoPopup()" class="px-4 py-2 accent-bg text-white rounded-lg font-semibold shadow hover:opacity-90">Rozumiem</button>
                </div>
            </div>
        </div>
    </div>

    <header class="accent-bg text-white pt-3 pb-4 md:pt-4 md:pb-5 text-center shadow-md">
        <div class="flex flex-col items-center gap-4">
            <img src="logo.png"
                 alt="Szlachetna Dziczyzna"
                 class="w-[380px] max-w-[90vw] h-auto drop-shadow-lg">
            <div class="sr-only">
                <h1 class="text-2xl md:text-3xl font-serif tracking-[0.15em] uppercase">
                    Szlachetna Dziczyzna
                </h1>
                <p class="mt-1 text-sm md:text-base tracking-wide uppercase text-amber-100">
                    Manufaktura wyrob√≥w rzemie≈õlniczych z polskich las√≥w
                </p>
            </div>
        </div>
    </header>

    <div class="max-w-5xl mx-auto p-6 bg-white shadow-lg mt-[-10px] rounded-lg relative z-10">
        
        <form id="order-form" onsubmit="sendOrder(event)">
            <div class="grid md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <section class="mb-6 p-5 md:p-6 section-intro rounded-2xl shadow-sm">
                        <div class="flex items-start gap-3">
                            <span class="text-2xl">üå≤</span>
                            <div>
                                <h2 class="text-xl md:text-2xl font-serif accent-text mb-3">
                                    Dlaczego nasza dziczyzna?
                                </h2>
                                <p class="text-[15px] md:text-base text-amber-900 leading-relaxed">
                                    Je≈õli chcesz mieƒá pewno≈õƒá, ≈ºe w miƒôsie jest
                                    <span class="font-semibold">100% miƒôsa ‚Äì bez antybiotyk√≥w, szczepionek i sztucznej paszy</span>,
                                    dobrze trafi≈Çe≈õ. Nasza dziczyzna pochodzi z wolnych zwierzƒÖt ≈ºyjƒÖcych w naturalnych warunkach. Starannie wyselekcjonowana i przygotowana wed≈Çug tradycyjnych receptur, z pasjƒÖ i szacunkiem do natury.
                                </p>
                                <p class="text-[15px] md:text-base text-amber-900 leading-relaxed mt-3">
                                    Ka≈ºda partia miƒôsa jest przebadana przez uprawnionego lekarza weterynarii i dopuszczona do spo≈ºycia. Nasze wyroby spe≈ÇniajƒÖ wszystkie obowiƒÖzujƒÖce normy sanitarne, dziƒôki czemu masz pewno≈õƒá, ≈ºe kupujesz dziczyznƒô bezpiecznƒÖ i najwy≈ºszej jako≈õci.
                                </p>
                            </div>
                        </div>
                    </section>

                    <section class="mb-8 p-5 md:p-6 section-products rounded-2xl shadow-sm">
                        <div class="flex items-center justify-between gap-3 flex-wrap">
                            <h2 class="text-2xl font-serif accent-text">Wybierz produkty</h2>
                        </div>
                        <div class="note-products rounded-xl p-4 mt-3 text-sm leading-relaxed">
                            <p class="font-semibold">Minimalna warto≈õƒá zam√≥wienia: <strong>200 z≈Ç</strong>.</p>
                            <p class="mt-1">‚öñÔ∏è Waga produkt√≥w jest orientacyjna (+/- 10%). Dok≈ÇadnƒÖ kwotƒô podamy po zwa≈ºeniu produkt√≥w.</p>
                            <p class="mt-2 font-semibold text-amber-900">Przyjƒôte ≈õrednie wagi sztuk:</p>
                            <ul class="list-disc pl-5 text-amber-900 space-y-1 mt-1">
                                <li>Salami: 0,5 kg / szt.</li>
                                <li>Polƒôdwica: 0,6 kg / szt.</li>
                                <li>Szynka: MA≈ÅA 0,5 kg / szt, DU≈ªA 0,85 kg / szt.</li>
                                <li>Kabanos warkocz: 0,5 kg / szt.</li>
                                <li>Kie≈Çbasa my≈õliwego: 0,5 kg / szt.</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-6 mt-6" id="products-container">
                            <p class="text-center text-gray-500 py-10">≈Åadowanie oferty z arkusza...</p>
                        </div>
                    </section>

                    <section class="section-form p-5 md:p-6 rounded-2xl shadow-sm">
                        <h2 class="text-2xl font-serif mb-4 border-b pb-2 accent-text">Dane do dostawy</h2>
                        
                        <div class="note-form p-4 mb-6 text-sm rounded-xl">
                            <p class="font-semibold">üöö Dostawa:</p>
                            <p>Dostawy realizujemy <strong>osobi≈õcie, przewa≈ºnie w poniedzia≈Çki</strong>. Zam√≥wienia przyjmowane sƒÖ od poniedzia≈Çku do czwartku.</p>
                            <p>Dostarczamy do 30 km od Warszawy. Mo≈ºliwy odbi√≥r 7 dni w tygodniu w Radzyminie.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" name="imie_nazwisko" placeholder="Imiƒô i Nazwisko" required class="p-3 border rounded w-full" autocomplete="name">
                            <input type="tel" name="telefon" placeholder="Numer telefonu" required class="p-3 border rounded w-full" autocomplete="tel">
                            <input type="email" name="email" placeholder="Adres Email" required class="p-3 border rounded w-full md:col-span-2" autocomplete="email">
                            <input type="text" name="miasto" placeholder="Miejscowo≈õƒá" required class="p-3 border rounded w-full" autocomplete="address-level2">
                            <input type="text" name="ulica" placeholder="Ulica i numer domu" required class="p-3 border rounded w-full" autocomplete="address-line1">
                            <textarea name="uwagi" placeholder="Uwagi (np. kod do domofonu)" class="p-3 border rounded w-full md:col-span-2" rows="2"></textarea>
                        </div>
                        <div id="form-errors" class="text-sm text-red-600 mt-2 hidden"></div>

                        <div class="mt-6 text-sm text-gray-700">
                            <label class="flex items-start gap-2">
                                <input type="checkbox" required class="mt-1">
                                <span>Wyra≈ºam zgodƒô na realizacjƒô zam√≥wienia i akceptujƒô termin dostawy (osobista, zwykle w poniedzia≈Çki) lub odbi√≥r w≈Çasny w Radzyminie.</span>
                            </label>
                        </div>
                    </section>
                </div>

                <!-- PODSUMOWANIE KOSZYKA -->
                <div class="cart-panel p-6 rounded-2xl shadow-sm md:sticky md:top-16 h-fit space-y-4">
                    <h3 class="font-bold text-gray-800 border-b pb-2 mb-2">Tw√≥j koszyk:</h3>
                    
                    <div id="cart-summary-list" class="text-sm space-y-2 mb-2 text-gray-700">
                        <p class="italic text-gray-500">Brak produkt√≥w.</p>
                    </div>

                    <div class="text-right border-t pt-3">
                        <span class="text-xl">Do zap≈Çaty (orientacyjnie): <strong id="total-price" class="accent-text text-2xl">0.00 z≈Ç</strong></span>
                    </div>

                    <div class="pt-2">
                        <label for="discount-code" class="text-sm font-semibold text-gray-800">Kod rabatowy</label>
                        <div class="mt-2 flex items-center gap-2">
                            <input type="text" id="discount-code" placeholder="np. START" class="p-2 border rounded text-sm w-full uppercase">
                            <button type="button" onclick="applyDiscount()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold whitespace-nowrap">U≈ºyj</button>
                        </div>
                        <p id="discount-message" class="text-right text-xs mt-1 text-green-700 font-semibold h-4"></p>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full accent-bg text-white font-bold py-4 rounded hover:opacity-90 transition text-lg shadow-lg">
                        Z≈Ç√≥≈º zam√≥wienie
                    </button>
                    <p id="status-msg" class="text-center mt-1 hidden text-sm"></p>
                </div>
            </div>
        </form>
    </div>

    <footer class="text-center text-gray-500 text-sm pb-10">
        <p>&copy; 2024 Szlachetna Dziczyzna.</p>
        <p class="mt-2">W razie pyta≈Ñ proszƒô o kontakt telefoniczny: <strong>+48 791 177 777</strong>.</p>
    </footer>

    <script>
        // === KONFIGURACJA ===
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSFPe99P7zAoHCVOezMhJPVMIwXJyaIl4MkHj8phq7Tq3ECF-e_5JXGYy2y3XP2GDO290G3djadkkPr/pub?output=csv'; 
        const SHEET_ID = '18bHIaug8Jv424muP0_r9mrmMglJbNqHGhnHTLELrzLE';
        const SHEET_TAB = 'Zamowienia';
        
        // Tw√≥j link do Google Apps Script (zapisywanie zam√≥wie≈Ñ)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVPB_OU3RqhmYXkTaaRIjqLTdB-WxlbJcl0BCd23ynqjj1QS1ZmMRexWOrr9E8e0Av/exec";
        
        // Twoje dane EmailJS (ju≈º wpisane)
        const EMAILJS_SERVICE = "service_5g54m0r";
        const EMAILJS_TEMPLATE = "template_5gttgro";
        
        const DISCOUNT_CODES = { "ZNAJOMY": 0.10, "PRZYJACIEL": 0.20 };
        const CATEGORY_ORDER = ["Kie≈Çbasy", "Wƒôdliny", "Przetwory", "Inne"];
        const MIN_ORDER = 200; // minimalna warto≈õƒá zam√≥wienia w z≈Ç
        const REQUEST_TIMEOUT_MS = 12000;
        let currentDiscount = 0;
        let hasItemsInCart = false;
        const PROMO_POPUP_KEY = 'promo-popup-2112';

        const PRODUCT_RULES = [
            { key: 'salami', match: (name) => name.includes('salami'), unit: 'szt', factor: 0.5, note: '≈örednia waga sztuki: 0,5 kg.' },
            { key: 'poledwica', match: (name) => name.includes('poledw') || name.includes('poled'), unit: 'szt', factor: 0.6, note: '≈örednia waga sztuki: 0,6 kg.' },
            { key: 'szynka', match: (name) => name.includes('szynk'), unit: 'szt', variants: [
                { label: 'MA≈ÅA 0,5 kg', factor: 0.5 },
                { label: 'DU≈ªA 0,85 kg', factor: 0.85 },
            ], note: '≈örednia waga sztuki: 0,5 kg (MA≈ÅA) lub 0,85 kg (DU≈ªA).' },
            { key: 'kabanos-warkocz', match: (name) => name.includes('kabanos warkocz'), unit: 'szt', factor: 0.5, note: '≈örednia waga sztuki: 0,5 kg.' },
            { key: 'kielbasa-mysliwego', match: (name) => name.includes('mysliweg'), unit: 'szt', factor: 0.5, note: '≈örednia waga sztuki: 0,5 kg.' },
            { key: 'pasztetowa-sloik', match: (name) => name.includes('pasztetowa w sloiku') || name.includes('pasztetowa w s≈Çoiku'), unit: 'szt', factor: 1 },
            { key: 'golonka-puszka', match: (name) => name.includes('golonka w puszce'), unit: 'szt', factor: 1 },
        ];

        const PRODUCT_RULES_MAP = PRODUCT_RULES.reduce((acc, rule) => {
            acc[rule.key] = rule;
            return acc;
        }, {});

        const findProductRule = (nameRaw = '') => {
            const name = normalizeKey(nameRaw);
            return PRODUCT_RULES.find((rule) => rule.match(name)) || null;
        };

        const getFieldValue = (item = {}, target = '') => {
            const targetKey = normalizeKey(target);
            const matchKey = Object.keys(item).find((key) => normalizeKey(key) === targetKey);
            return matchKey ? item[matchKey] : undefined;
        };

        const parseStockValue = (raw) => {
            if (raw === null || raw === undefined) return null;
            const cleaned = String(raw).replace(',', '.').replace(/[^0-9.-]/g, '').trim();
            if (cleaned === '') return null;
            const val = parseFloat(cleaned);
            return Number.isFinite(val) ? val : null;
        };

        const getVariantStocks = (item = {}) => {
            return {
                small: parseStockValue(getFieldValue(item, 'Dostƒôpno≈õƒá (ma≈Ça)')),
                large: parseStockValue(getFieldValue(item, 'Dostƒôpno≈õƒá (du≈ºa)'))
            };
        };

        const normalizeKey = (str = '') => str
            .normalize("NFD")
            .replace(/\p{Diacritic}/gu, '')
            .toLowerCase()
            .trim();

        const normalizeImageKey = (str = '') => str
            .normalize("NFD")
            .replace(/\p{Diacritic}/gu, '')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');

        const IMAGE_MAP = {
            [normalizeImageKey('Golonka w puszce 200g')]: 'golonka_puszka.jpeg',
            [normalizeImageKey('Pasztetowa w s≈Çoiku 350ml')]: 'pasztetowa_sloik.jpeg',
            [normalizeImageKey('Kie≈Çbasa my≈õliwska z SarnƒÖ')]: 'kielbasa.jpeg',
            [normalizeImageKey('Kie≈Çbasa my≈õliwska z Jeleniem')]: 'kielbasa2.jpeg',
            [normalizeImageKey('Kie≈Çbasa my≈õliwego')]: 'kielbasa_mysliwego.jpeg',
            [normalizeImageKey('Polƒôdwica ≈Çososiowa z Dzika')]: 'poledwica_lososiowa_dzik.jpeg',
            [normalizeImageKey('Polƒôdwica ≈Çososiowa z Jelenia')]: 'poledwica_lososiowa_sarna.jpeg',
            [normalizeImageKey('Polƒôdwica ≈Çososiowa z Sarny')]: 'poledwica_lososiowa_sarna.jpeg',
            [normalizeImageKey('Szynka z Dzika w zio≈Çach')]: 'szynka_w_ziolach_dzik.jpeg',
            [normalizeImageKey('Szynka z Jelenia w zio≈Çach')]: 'szynka_w_ziolach_jelen.jpeg',
            [normalizeImageKey('Szynka z Sarny w zio≈Çach')]: 'szynka_w_ziolach_jelen.jpeg',
            [normalizeImageKey('Par√≥wki z Dzika')]: 'parowki2.jpeg',
            [normalizeImageKey('Par√≥wki z Jelenia')]: 'parowki2.jpeg',
            [normalizeImageKey('Par√≥wki z Daniela')]: 'parowki2.jpeg',
            [normalizeImageKey('Par√≥wki z Sarny')]: 'parowki2.jpeg',
            [normalizeImageKey('Kabanos warkocz')]: 'kabanos_warkocz.jpeg',
            [normalizeImageKey('Kabanos z Dzika')]: 'kabanosy_dzik.jpeg',
            [normalizeImageKey('Kabanos z Jelenia')]: 'kabanosy_dzik.jpeg',
            [normalizeImageKey('Kabanos z Sarny')]: 'kabanosy_dzik.jpeg',
            [normalizeImageKey('Salami dojrzewajƒÖce z Jelenia')]: 'salami_jelen.jpeg',
        };

        const getAvailability = (item) => {
            const small = parseStockValue(getFieldValue(item, 'Dostƒôpno≈õƒá (ma≈Ça)'));
            const large = parseStockValue(getFieldValue(item, 'Dostƒôpno≈õƒá (du≈ºa)'));
            if (small !== null || large !== null) {
                const sum = (small || 0) + (large || 0);
                return sum || 0;
            }
            const key = Object.keys(item).find(k => normalizeKey(k) === 'dostepnosc');
            if (!key) return 0;
            const raw = item[key];
            const stock = parseStockValue(raw);
            return stock || 0;
        };

        const isItemAvailable = (item) => {
            const stock = getAvailability(item);
            return stock !== null ? stock > 0 : false;
        };

        const sortCategoryItems = (items, catName) => {
            const priority = (name) => {
                const t = name.toLowerCase();
                if (catName === "Kie≈Çbasy") {
                    if (t.includes('par√≥w')) return 0;
                    if (t.includes('kielb') || t.includes('kie≈Çb')) return 1;
                    if (t.includes('kabanos')) return 2;
                    return 3;
                }
                if (catName === "Wƒôdliny") {
                    if (t.includes('szynk')) return 0;
                    if (t.includes('salami')) return 1;
                    if (t.includes('polƒôd') || t.includes('poled')) return 2;
                    return 3;
                }
                return 99;
            };
            return [...items].sort((a, b) => {
                const pa = priority(a.name);
                const pb = priority(b.name);
                if (pa !== pb && pa !== 99 && pb !== 99) return pa - pb;
                return a.name.localeCompare(b.name, 'pl');
            });
        };

        function parsePrice(priceString) {
            if (!priceString) return 0;
            let cleanString = priceString.toString().replace(/z≈Ç/g, '').replace(/,/g, '.').trim();
            return parseFloat(cleanString) || 0;
        }

        function sanitizeQtyInput(input) {
            const step = parseFloat(input.step) || 0.1;
            const decimals = (step.toString().split('.')[1] || '').length;
            const maxStock = isFinite(parseFloat(input.dataset.stock)) ? parseFloat(input.dataset.stock) : null;
            let val = parseFloat(input.value) || 0;
            val = Math.max(0, val);
            if (maxStock !== null) val = Math.min(val, maxStock);
            const rounded = decimals === 0 ? Math.round(val) : Math.round(val / step) * step;
            const fixed = decimals === 0 ? rounded : parseFloat(rounded.toFixed(decimals));
            let finalVal = decimals === 0 ? fixed : parseFloat(fixed.toFixed(decimals));
            if (maxStock !== null && finalVal > maxStock) finalVal = maxStock;
            input.value = decimals === 0 ? String(finalVal) : finalVal.toFixed(decimals);
            return parseFloat(input.value) || 0;
        }

        function generateOrderNumber() {
            try {
                const key = 'orderCounter';
                let current = parseInt(localStorage.getItem(key), 10);
                if (isNaN(current) || current < 300) current = 300;
                const next = current + 1;
                localStorage.setItem(key, next);
                return String(next);
            } catch (e) {
                return String(Date.now());
            }
        }

        async function requestOrderNumber() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);
            const payload = {
                action: "nextOrderNumber",
                sheet_id: SHEET_ID,
                sheet_tab: SHEET_TAB
            };
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                if (!response.ok) throw new Error("order-number-http");
                const data = await response.json().catch(() => null);
                const rawNr = data && (data.orderNumber || data.order_number || data.number);
                const nr = rawNr ? String(rawNr).replace(/^DZ[-\s]?/i, '') : '';
                if (!nr) throw new Error("order-number-missing");
                return nr;
            } catch (err) {
                console.warn("Nie uda≈Ço siƒô pobraƒá numeru z serwera, u≈ºywam lokalnego.", err);
                return generateOrderNumber();
            } finally {
                clearTimeout(timeoutId);
            }
        }

        function setStatus(message, isError = false, isPending = false) {
            const status = document.getElementById('status-msg');
            status.classList.remove('hidden');
            status.className = `text-center mt-4 font-bold p-4 rounded ${isError ? 'text-red-700 bg-red-50' : 'text-green-700 bg-green-50'} ${isPending ? 'animate-pulse' : ''}`;
            status.innerHTML = message;
        }

        function clearStatus() {
            const status = document.getElementById('status-msg');
            status.classList.add('hidden');
            status.textContent = '';
            status.className = 'text-center mt-4 hidden';
        }

        function setFormError(text) {
            const box = document.getElementById('form-errors');
            if (!text) {
                box.classList.add('hidden');
                box.textContent = '';
                return;
            }
            box.classList.remove('hidden');
            box.textContent = text;
        }

        function validateFormFields() {
            const form = document.forms['order-form'];
            const requiredFields = [
                { field: form.imie_nazwisko, label: "Imiƒô i nazwisko" },
                { field: form.telefon, label: "Telefon" },
                { field: form.email, label: "Email" },
                { field: form.miasto, label: "Miejscowo≈õƒá" },
                { field: form.ulica, label: "Ulica i numer" },
            ];

            for (const { field, label } of requiredFields) {
                if (!field.value.trim()) {
                    setFormError(`Uzupe≈Çnij pole: ${label}.`);
                    field.focus();
                    return false;
                }
            }

            const phoneValid = /^[0-9 +()-]{6,}$/.test(form.telefon.value.trim());
            if (!phoneValid) {
                setFormError("Podaj poprawny numer telefonu.");
                form.telefon.focus();
                return false;
            }

            setFormError('');
            return true;
        }

        Papa.parse(SHEET_URL, {
            download: true,
            header: true,
            complete: function(results) {
                if(results.data.length === 0) {
                     document.getElementById('products-container').innerHTML = '<p class="text-red-500 text-center font-bold">Arkusz jest pusty lub b≈ÇƒÖd odczytu.</p>';
                     return;
                }
                renderProducts(results.data);
            },
            error: function(err) {
                console.error("B≈ÇƒÖd PapaParse:", err);
                document.getElementById('products-container').innerHTML = '<div class="text-center text-red-600 font-bold">B≈ÇƒÖd ≈Çadowania oferty.</div>';
            }
        });

        function normalizeCategory(catRaw, name = '', desc = '') {
            const c = (catRaw || '').toString().toLowerCase();
            const n = (name || '').toString().toLowerCase();
            const d = (desc || '').toString().toLowerCase();

            const matchKielbasy = (text) => text.includes('kie≈Çb') || text.includes('kielb') || text.includes('kabanos') || text.includes('par√≥w') || text.includes('grill') || text.includes('salami');
            const matchWedliny = (text) => text.includes('wƒôdlin') || text.includes('wedlin') || text.includes('szynk') || text.includes('boczek') || text.includes('polƒôd') || text.includes('poled') || text.includes('baleron') || text.includes('schab');
            const matchPrzetwory = (text) => text.includes('przetw') || text.includes('paszt') || text.includes('smalec') || text.includes('gulasz') || text.includes('konserw') || text.includes('bulion') || text.includes('s≈Çoik') || text.includes('sloik');

            if (matchKielbasy(c) || matchKielbasy(n) || matchKielbasy(d)) return "Kie≈Çbasy";
            if (matchWedliny(c) || matchWedliny(n) || matchWedliny(d)) return "Wƒôdliny";
            if (matchPrzetwory(c) || matchPrzetwory(n) || matchPrzetwory(d)) return "Przetwory";
            return c ? c.charAt(0).toUpperCase() + c.slice(1) : "Inne";
        }

        function slugifyCategory(name) {
            return name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        }

        function renderProducts(data) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';

            const categories = {};
            let idx = 0;

            const sorted = [...data].sort((a, b) => {
                const availA = isItemAvailable(a) ? 1 : 0;
                const availB = isItemAvailable(b) ? 1 : 0;
                return availB - availA;
            });

            sorted.forEach((item) => {
                if (!item['Nazwa']) return; 
                const category = normalizeCategory(item['Kategoria'] || item['Kategoria (PL)'] || item['Kategoria1'], item['Nazwa'], item['Opis']);

                const stock = getAvailability(item);
                const maxQty = isFinite(stock) && stock > 0 ? stock : null;
                const isAvailable = maxQty ? maxQty > 0 : stock > 0;
                const disabledClass = isAvailable ? '' : 'out-of-stock';
                const statusText = '';
                const soldOutNote = isAvailable ? '' : '<span class="text-xs font-bold text-red-700 mt-2 block">Wyprzedane</span>';
                
                const nazwa = item['Nazwa'];
                const nameSlug = (nazwa || '').toString().toLowerCase();
                const cena = parsePrice(item['Cena']);
                const rule = findProductRule(nazwa);
                const isSzynka = rule?.key === 'szynka';
                const isPoledwica = rule?.key === 'poledwica';
                const variantStocks = isSzynka ? getVariantStocks(item) : {};
                let unit = (item['Jednostka'] || 'kg').toString();
                let displayUnit = unit.trim();
                let step = unit.toLowerCase().includes('szt') ? 1 : 0.1;
                let displayPrice = cena;
                if (rule) {
                    displayUnit = 'szt';
                    step = 1;
                    const factor = rule.variants ? rule.variants[0].factor : (rule.factor || 1);
                    displayPrice = cena * factor;
                }
                const expiry = item['Wa≈ºno≈õƒá'];
                const sklad = item['Sk≈Çad'] || '';
                const opis = item['Opis'] || '';
                const imageKeyName = normalizeImageKey(nazwa);
                let imageUrl = IMAGE_MAP[imageKeyName] || item['Zdjƒôcie'] || item['Zdjecie'] || item['Foto'] || item['Obraz'] || '';
                if (!imageUrl && (nameSlug.includes('kielb') || nameSlug.includes('kie≈Çb'))) {
                    imageUrl = 'kielbasa.jpeg';
                }
                const imageBlock = imageUrl ? `
                    <img src="${imageUrl}" alt="Zdjƒôcie produktu ${nazwa}" class="w-full h-32 object-contain rounded-lg border shadow-sm bg-white">
                ` : `
                    <div class="w-full h-32 bg-gray-100 text-gray-400 text-xs rounded-lg border flex items-center justify-center">
                        Brak zdjƒôcia
                    </div>
                `;
                const productIndex = idx;
                idx += 1;
                const variantOptions = isSzynka
                    ? PRODUCT_RULES_MAP.szynka.variants.map((variant) => `<option value="${variant.label}" data-factor="${variant.factor}">${variant.label}</option>`).join('')
                    : '';
                const variantSelect = isSzynka ? `
                    <label class="w-full text-xs font-semibold text-amber-800 mb-2">
                        Wybierz wielko≈õƒá:
                        <select id="variant-${productIndex}" class="mt-1 w-full border rounded-lg p-2 text-sm" onchange="updateVariantPrice(${productIndex})">
                            ${variantOptions}
                        </select>
                    </label>
                ` : '';
                const poledwicaNote = isPoledwica ? `
                    <div class="mt-2 text-xs font-semibold text-amber-800">
                        Sprzeda≈º w sztukach; finalna kwota po zwa≈ºeniu.
                    </div>
                ` : '';
                const weightNote = rule && rule.note ? `
                    <p class="text-xs text-amber-800 mt-1">${rule.note}</p>
                ` : '';
                const lowStockNote = (!isSzynka && maxQty && maxQty <= 5)
                    ? `<span class="text-xs text-amber-700 font-semibold mt-1 block">Zosta≈Ço ostatnie ${maxQty} ${displayUnit}.</span>`
                    : '';
                const variantKeyFromLabel = (label) => normalizeKey(label).includes('duz') ? 'large' : 'small';
                const initialVariant = isSzynka ? PRODUCT_RULES_MAP.szynka.variants[0] : null;
                const initialVariantKey = isSzynka ? variantKeyFromLabel(initialVariant.label) : null;
                const initialStock = isSzynka ? variantStocks[initialVariantKey] : (maxQty !== null ? maxQty : null);
                const stockNote = isSzynka ? `
                    <p id="stock-note-${productIndex}" class="text-xs text-amber-800 mt-1 ${initialStock === null ? 'hidden' : ''}">
                        Dostƒôpne: ${initialStock !== null ? initialStock : ''} szt.
                    </p>
                ` : '';

                const hasDetails = Boolean(opis || sklad || expiry);
                const detailsId = `details-${productIndex}`;
                const detailsButton = hasDetails ? `
                    <button type="button" class="text-sm font-semibold text-amber-800 flex items-center gap-2 mt-2" onclick="toggleDetails('${detailsId}', this)">
                        <span class="inline-block transition-transform rotate-0">‚ñº</span>
                        <span>Szczeg√≥≈Çy</span>
                    </button>
                ` : '';
                const detailsBlock = hasDetails ? `
                    <div id="${detailsId}" class="mt-2 text-sm text-gray-700 bg-amber-50 border border-amber-100 rounded-lg p-3 hidden">
                        ${opis ? `<p class="text-sm text-gray-700 leading-relaxed">${opis}</p>` : ''}
                        ${sklad ? `<p class="text-xs italic text-gray-500 mt-2"><span class="font-semibold not-italic text-gray-700">Sk≈Çad:</span> ${sklad}</p>` : ''}
                        ${expiry ? `<p class="text-xs text-amber-700 font-semibold mt-2">‚è≥ Wa≈ºno≈õƒá: ${expiry}</p>` : ''}
                    </div>
                ` : '';
                const szynkaStockAttrs = isSzynka
                    ? ` data-small-stock="${variantStocks.small ?? ''}" data-large-stock="${variantStocks.large ?? ''}"`
                    : '';
                const html = `
                <div class="flex flex-col gap-3 border-b pb-6 product-item ${disabledClass}" data-index="${productIndex}" data-kind="${rule ? rule.key : ''}" data-rule="${rule ? rule.key : ''}" data-base-price="${cena}"${szynkaStockAttrs}>
                    <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4">
                        <div class="flex flex-col sm:flex-row gap-4 w-full p-4 bg-white/80 rounded-xl shadow-sm border border-gray-100">
                            <div class="flex-1 mb-4 sm:mb-0 order-1 sm:order-2">
                                <h3 class="text-lg md:text-xl font-semibold accent-text flex items-start">
                                    <span class="text-gray-400 mr-2 leading-snug pt-0.5">${idx}.</span>
                                    <span class="leading-snug">${nazwa} ${statusText}</span>
                                </h3>
                                <div class="mt-2 sm:hidden">
                                    ${imageBlock}
                                </div>
                                <div class="mt-3 inline-flex items-center gap-2 px-3 py-2 bg-amber-100/80 text-amber-900 rounded-full shadow-sm">
                                    <span class="price text-xl md:text-2xl font-extrabold tracking-tight" data-price="${cena}" data-base-price="${cena}">
                                        ${displayPrice.toFixed(2)} z≈Ç
                                    </span>
                                    <span class="text-xs md:text-sm uppercase font-semibold text-amber-800">/ ${displayUnit}</span>
                                </div>
                                ${weightNote}
                            </div>
                            <div class="w-full sm:w-32 flex-shrink-0 order-2 sm:order-1 hidden sm:block">
                                ${imageBlock}
                            </div>
                        </div>
                        <div class="flex flex-col items-end sm:items-center mt-2 sm:mt-0">
                            ${variantSelect}
                            <div class="flex items-center bg-gray-50 p-2 rounded-full shadow-inner">
                                <button type="button" onclick="changeQty(${productIndex}, -${step})" class="w-8 h-8 md:w-9 md:h-9 flex items-center justify-center bg-amber-200 text-amber-900 rounded-full hover:bg-amber-300 active:scale-95 transition text-lg">-</button>
                                
                                <input type="number" 
                                    min="0" 
                                    step="${step}" 
                                placeholder="0" 
                                id="qty-${productIndex}"
                                class="qty-input w-20 md:w-24 p-2 mx-2 text-center bg-transparent border-b-2 border-gray-300 focus:border-amber-700 focus:outline-none text-base" 
                                name="${nazwa}"
                                data-unit="${displayUnit}"
                                data-stock="${initialStock !== null ? initialStock : ''}"
                                oninput="calculateTotal()">
                                
                                <button type="button" onclick="changeQty(${productIndex}, ${step})" class="w-8 h-8 md:w-9 md:h-9 flex items-center justify-center bg-amber-200 text-amber-900 rounded-full hover:bg-amber-300 active:scale-95 transition text-lg">+</button>
                            </div>
                            <p id="line-total-${productIndex}" class="text-sm font-bold text-green-700 mt-2 opacity-0 transition-opacity duration-200">0.00 z≈Ç</p>
                            ${soldOutNote}
                            ${isSzynka ? stockNote : lowStockNote}
                            ${poledwicaNote}
                        </div>
                    </div>
                    ${hasDetails ? `<div class="w-full px-1 sm:px-0">${detailsButton}${detailsBlock}</div>` : ''}
                </div>`;
                
                if (!categories[category]) categories[category] = { available: [], unavailable: [] };
                const bucket = isAvailable ? 'available' : 'unavailable';
                categories[category][bucket].push({ name: nazwa, html });
            });

            CATEGORY_ORDER.forEach((catName, i) => {
                if (!categories[catName] || (categories[catName].available.length === 0 && categories[catName].unavailable.length === 0)) return;
                const availableSorted = sortCategoryItems(categories[catName].available, catName);
                const unavailableSorted = sortCategoryItems(categories[catName].unavailable, catName);
                const sortedItems = [...availableSorted, ...unavailableSorted];
                let localIdx = 1;
                const rendered = sortedItems.map(item => {
                    const numbered = item.html.replace(/<span class="text-gray-400 mr-2">.*?<\/span>/, `<span class="text-gray-400 mr-2">${localIdx}.<\/span>`);
                    localIdx += 1;
                    return numbered;
                });
                const sectionId = `cat-${slugifyCategory(catName)}`;
                const isOpen = i === 0;
                const sectionHtml = `
                <div class="category-section border rounded-lg mb-4 overflow-hidden">
                    <button type="button"
                        class="w-full flex justify-between items-center bg-gray-50 px-4 py-3 font-semibold accent-text text-left border-b border-gray-200 text-lg md:text-xl"
                        onclick="toggleCategory('${sectionId}')">
                        <span class="font-serif">${catName}</span>
                        <span id="${sectionId}-chevron" class="transition-transform ${isOpen ? 'rotate-180' : ''}">‚ñº</span>
                    </button>
                    <div id="${sectionId}" class="category-body ${isOpen ? '' : 'hidden'} divide-y">
                        ${rendered.join('')}
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', sectionHtml);
            });
        }

        window.changeQty = function(index, delta) {
            const input = document.getElementById(`qty-${index}`);
            let val = parseFloat(input.value) || 0;
            val += delta;
            input.value = val;
            sanitizeQtyInput(input);
            calculateTotal();
        }

        window.toggleCategory = function(id) {
            const body = document.getElementById(id);
            const chevron = document.getElementById(`${id}-chevron`);
            if (!body) return;
            body.classList.toggle('hidden');
            if (chevron) chevron.classList.toggle('rotate-180');
        }

        window.toggleDetails = function(id, btn) {
            const body = document.getElementById(id);
            if (!body) return;
            const willShow = body.classList.contains('hidden');
            body.classList.toggle('hidden');
            if (btn) {
                const spans = btn.querySelectorAll('span');
                if (spans[0]) spans[0].classList.toggle('rotate-180', willShow);
                if (spans[1]) spans[1].textContent = willShow ? 'Ukryj szczeg√≥≈Çy' : 'Szczeg√≥≈Çy';
            }
        }

        window.adjustCartItem = function(index, delta) {
            const input = document.getElementById(`qty-${index}`);
            if (!input) return;
            let val = parseFloat(input.value) || 0;
            val += delta;
            input.value = val;
            sanitizeQtyInput(input);
            calculateTotal();
        }

        window.removeCartItem = function(index) {
            const input = document.getElementById(`qty-${index}`);
            if (!input) return;
            input.value = 0;
            calculateTotal();
        }

        window.calculateTotal = function() {
            let total = 0;
            const cartSummary = document.getElementById('cart-summary-list');
            let summaryHTML = '';
            let hasItems = false;

            hasItemsInCart = false;

            document.querySelectorAll('.product-item').forEach((item) => {
                if (item.classList.contains('out-of-stock')) return;
                
                const index = item.dataset.index;
                const nameRaw = item.querySelector('h3').textContent.trim().replace('(Wyprzedane)', '');
                const nameBase = nameRaw.replace(/^\d+\.?\s*/, '');
                const variant = getVariantLabel(index);
                const name = variant ? `${nameBase} (${variant})` : nameBase;
                const priceEl = item.querySelector('.price');
                const price = parseFloat(item.dataset.basePrice || priceEl?.dataset.basePrice || priceEl?.dataset.price) || 0;
                const input = item.querySelector('.qty-input');
                const unit = input.dataset.unit;
                const stepVal = parseFloat(input.step) || 0.1;
                const qty = sanitizeQtyInput(input);
                const ruleKey = item.dataset.rule || '';
                const rule = PRODUCT_RULES_MAP[ruleKey];
                let factor = 1;
                if (rule) {
                    factor = rule.variants ? getVariantFactor(index) : (rule.factor || 1);
                }

                const lineTotal = price * qty * factor;
                const lineTotalEl = document.getElementById(`line-total-${index}`);
                
                if(lineTotalEl) {
                    if (qty > 0) {
                        lineTotalEl.textContent = lineTotal.toFixed(2) + ' z≈Ç';
                        lineTotalEl.classList.remove('opacity-0');
                        hasItems = true;
                        hasItemsInCart = true;
                        summaryHTML += `
                        <div class="flex justify-between items-center border-b border-gray-200 border-dashed pb-1 last:border-0">
                            <div class="space-y-1">
                                <span class="font-semibold text-gray-800">${name}</span>
                                <div class="flex flex-wrap items-center gap-2 text-xs text-gray-600">
                                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-amber-50 border border-amber-200 rounded-full text-amber-800 font-semibold">
                                        <span class="text-sm">${qty}</span>
                                        <span class="text-[10px] uppercase tracking-wide">${unit}</span>
                                    </span>
                                    <div class="inline-flex items-center gap-1">
                                        <button type="button" class="px-2 py-1 border rounded-lg bg-white hover:bg-gray-100" onclick="adjustCartItem(${index}, -${stepVal})">-</button>
                                        <button type="button" class="px-2 py-1 border rounded-lg bg-white hover:bg-gray-100" onclick="adjustCartItem(${index}, ${stepVal})">+</button>
                                        <button type="button" class="px-2 py-1 border rounded-lg bg-white hover:bg-red-50 text-red-600 border-red-200" onclick="removeCartItem(${index})">Usu≈Ñ</button>
                                    </div>
                                </div>
                            </div>
                            <span class="font-semibold">${lineTotal.toFixed(2)} z≈Ç</span>
                        </div>`;
                    } else {
                        lineTotalEl.classList.add('opacity-0');
                    }
                }
                total += lineTotal;
            });

            let discountAmount = 0;
            if (currentDiscount > 0 && total > 0) {
                discountAmount = total * currentDiscount;
                summaryHTML += `
                <div class="flex justify-between items-center text-green-700 mt-2 pt-2 border-t">
                    <span>Rabat (${currentDiscount * 100}%)</span>
                    <span class="font-bold">-${discountAmount.toFixed(2)} z≈Ç</span>
                </div>`;
                total = total - discountAmount;
            }

            if (hasItems) {
                cartSummary.innerHTML = summaryHTML;
            } else {
                cartSummary.innerHTML = '<p class="italic text-gray-400">Wybierz produkty powy≈ºej, aby zobaczyƒá podsumowanie.</p>';
            }

            document.getElementById('total-price').textContent = total.toFixed(2) + ' z≈Ç';
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = !hasItemsInCart;
            submitBtn.classList.toggle('opacity-50', !hasItemsInCart);
        }

        window.applyDiscount = function() {
            const codeInput = document.getElementById('discount-code').value.toUpperCase();
            const msg = document.getElementById('discount-message');
            if (DISCOUNT_CODES[codeInput]) {
                currentDiscount = DISCOUNT_CODES[codeInput];
                msg.textContent = `Kod aktywny! -${currentDiscount * 100}%`;
                msg.className = "text-right text-xs mt-1 text-green-600 font-bold h-4";
            } else {
                currentDiscount = 0;
                msg.textContent = "B≈Çƒôdny kod.";
                msg.className = "text-right text-xs mt-1 text-red-500 font-bold h-4";
            }
            calculateTotal();
        }

        function saveOrderToSheet(orderData) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);

            const send = (mode) => fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(orderData),
                signal: controller.signal
            });

            return send("cors")
                .then((response) => {
                    if (response.type === 'opaque') return;
                    if (!response.ok) throw new Error("sheet-save-failed");
                    return response.json().catch(() => ({}));
                })
                .catch((err) => {
                    if (err.name === 'AbortError') {
                        throw new Error("sheet-save-timeout");
                    }
                    // Je≈õli CORS siƒô wywali, pr√≥bujemy best-effort no-cors
                    return send("no-cors").catch(() => { throw err; });
                })
                .finally(() => clearTimeout(timeoutId));
        }

        function getVariantLabel(index) {
            const select = document.getElementById(`variant-${index}`);
            return select ? select.value : '';
        }

        function getVariantKey(label = '') {
            return normalizeKey(label).includes('duz') ? 'large' : 'small';
        }

        function getVariantFactor(index) {
            const select = document.getElementById(`variant-${index}`);
            if (!select) return 1;
            const option = select.options[select.selectedIndex];
            const factorRaw = option?.dataset.factor;
            const factor = factorRaw ? parseFloat(factorRaw) : parseFloat(select.value);
            return Number.isFinite(factor) ? factor : 1;
        }

        window.updateVariantPrice = function(index) {
            const item = document.querySelector(`.product-item[data-index="${index}"]`);
            if (!item) return;
            const priceEl = item.querySelector('.price');
            const basePrice = parseFloat(item.dataset.basePrice || priceEl?.dataset.basePrice || priceEl?.dataset.price);
            const factor = getVariantFactor(index);
            const variantLabel = getVariantLabel(index);
            const variantKey = getVariantKey(variantLabel);
            const stockNote = document.getElementById(`stock-note-${index}`);
            const stockValueRaw = variantKey === 'large' ? item.dataset.largeStock : item.dataset.smallStock;
            const stockValue = parseStockValue(stockValueRaw);
            const qtyInput = document.getElementById(`qty-${index}`);
            if (qtyInput) {
                qtyInput.dataset.stock = stockValue !== null ? stockValue : '';
                sanitizeQtyInput(qtyInput);
            }
            if (stockNote) {
                if (stockValue !== null) {
                    stockNote.textContent = `Dostƒôpne: ${stockValue} szt.`;
                    stockNote.classList.remove('hidden');
                } else {
                    stockNote.classList.add('hidden');
                }
            }
            if (Number.isFinite(basePrice) && priceEl) {
                priceEl.textContent = `${(basePrice * factor).toFixed(2)} z≈Ç`;
            }
            calculateTotal();
        }

        function showPromoPopup() {
            const key = PROMO_POPUP_KEY;
            try {
                const stored = localStorage.getItem(key);
                if (stored === 'hidden') return;
            } catch (e) {}
            const popup = document.getElementById('promo-popup');
            if (popup) popup.classList.remove('hidden');
        }

        window.closePromoPopup = function() {
            const popup = document.getElementById('promo-popup');
            if (popup) popup.classList.add('hidden');
            try { localStorage.setItem(PROMO_POPUP_KEY, 'hidden'); } catch (e) {}
        }

        document.addEventListener('DOMContentLoaded', () => {
            showPromoPopup();
        });

        window.sendOrder = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const status = document.getElementById('status-msg');
            const totalText = document.getElementById('total-price').innerText || '0';
            const totalValue = parseFloat(
                totalText
                    .replace('z≈Ç', '')
                    .replace(/\s/g, '')
                    .replace(',', '.')
            );
            if (isNaN(totalValue) || totalValue < MIN_ORDER) {
                alert(`Minimalna warto≈õƒá zam√≥wienia to ${MIN_ORDER} z≈Ç.`);
                return;
            }

            clearStatus();
            if (!validateFormFields()) return;

            setStatus("Pobieram numer zam√≥wienia...", false, true);
            const orderNumber = await requestOrderNumber();
            let orderSummary = `Numer zam√≥wienia: ${orderNumber}\n`;
            let hasProducts = false;
            let lineItems = [];

            document.querySelectorAll('.product-item').forEach((item) => {
                const index = item.dataset.index;
                const input = item.querySelector('.qty-input');
                const qty = parseFloat(input.value) || 0;
                
                if(qty > 0) {
                    hasProducts = true;
                    const nameRaw = item.querySelector('h3').textContent.trim().replace('(Wyprzedane)', '');
                    const nameBase = nameRaw.replace(/^\d+\.?\s*/, '');
                    const variant = getVariantLabel(index);
                    const name = variant ? `${nameBase} (${variant})` : nameBase;
                    const unit = input.dataset.unit;
                    const linePrice = document.getElementById(`line-total-${index}`).textContent;
                    orderSummary += `${name}: ${qty} ${unit} (Razem: ${linePrice})\n`;
                    lineItems.push({ name, qty, unit });
                }
            });

            if(!hasProducts) { alert("Wybierz produkty."); return; }

            btn.disabled = true;
            btn.textContent = "Zapisywanie zam√≥wienia...";
            setStatus("Zapisywanie w systemie...", false, true);

            const form = document.forms['order-form'];
            const addressFull = `${form.ulica.value}, ${form.miasto.value}`;
            const totalPrice = document.getElementById('total-price').innerText;

            const orderData = {
                sheet_id: SHEET_ID,
                sheet_tab: SHEET_TAB,
                // Pola dla Arkusza Google
                imie_nazwisko: form.imie_nazwisko.value,
                email: form.email.value,
                telefon: form.telefon.value,
                adres: addressFull,
                uwagi: form.uwagi.value,
                szczegoly: orderSummary,
                zamowienie: orderSummary,
                kwota: totalPrice,
                line_items: lineItems,
                
                // Pola dla EmailJS
                to_name: "Sprzedawca",
                customer_name: form.imie_nazwisko.value,
                customer_email: form.email.value,
                phone: form.telefon.value,
                delivery_method: "Dostawa Osobista (Czwartek)", 
                address: addressFull,
                notes: form.uwagi.value,
                order_details: orderSummary,
                total_price: totalPrice,
                discount_info: currentDiscount > 0 ? "TAK" : "NIE",
                order_number: orderNumber
            };

            // KROK 1: WYSY≈ÅKA DO GOOGLE SHEETS
            saveOrderToSheet(orderData)
                .then(() => {
                    setStatus("Zapisywanie w systemie... OK. Wysy≈Çamy potwierdzenie e-mail.", false, true);
                    // KROK 2: WYSY≈ÅKA MAILA (EmailJS)
                return emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, orderData);
            })
            .then(() => {
                setStatus(`‚úÖ Zam√≥wienie przyjƒôte! Nr: ${orderNumber}. Zapisano w systemie i wys≈Çano potwierdzenie.`, false, false);
                btn.style.display = 'none';
            })
                .catch((err) => {
                    console.error("B≈ÇƒÖd:", err);
                    const errorMsg = err.message === "sheet-save-timeout"
                        ? "Nie uda≈Ço siƒô potwierdziƒá zapisu (przekroczono czas). Spr√≥buj ponownie lub skontaktuj siƒô telefonicznie."
                        : "Nie uda≈Ço siƒô zapisaƒá zam√≥wienia. Spr√≥buj ponownie lub skontaktuj siƒô telefonicznie.";
                    setStatus(`‚ö†Ô∏è ${errorMsg}`, true, false);
                    btn.disabled = false;
                    btn.textContent = "Spr√≥buj ponownie";
                });
        }
    </script>
</body>
</html>
